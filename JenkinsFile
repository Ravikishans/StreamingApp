pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = 'ravikishans'
        DOCKER_CREDENTIALS = credentials('ravikishans')

        BACKEND_AUTH_NAMESPACE = 'beauth'
        BACKEND_STREAM_NAMESPACE = 'bestream'
        FRONTEND_NAMESPACE = 'frontend'
        DATABASE_NAMESPACE = 'db'


        HELM_RELEASE_NAME = "streamingapp"
        HELM_CHART_PATH = './k8s/streamingapp'
    }

    stages {

        stage ('checkout code') {
            steps {
                script {
                    git branch: 'main' , url: 'https://github.com/Ravikishans/StreamingApp.git'
                }
            }
        }
        stage("ls") {
            steps {
                script {
                    sh """
                    ls -al
                    """
                }
            }
        }

        stage ("add .env in backend auth") {
            steps {
                script {
                    sh """
                    echo "PORT=3001
                    MONGO_URL="mongodb://root:example@mongo-svc.db.svc.cluster.local:27017/admin"
                    AWS_REGION='ap-northeast-2'" > ./backend/authService/.env

                    ls -al ./backend/authService
                    """
                }
            }
        }

        stage ("add .env in backend streaming") {
            steps {
                script {
                    sh """
                    echo "PORT=3002
                    MONGO_URL="mongodb://root:example@mongo-svc.db.svc.cluster.local:27017/admin"
                    AWS_REGION='ap-northeast-2'" > ./backend/streamingService/.env

                    ls -al ./backend/streamingService
                    """
                }
            }
        }

        // stage("add .env in frontend") {
        //     steps {
        //         script {
        //             sh """
        //             echo BACKEND_URL = "http://localhost:3002" > ./frontend/.env

        //             ls -al ./frontend
        //             """
        //         }
        //     }
        // }
            

        stage('build and push docker images') {
            steps {
                script {
                    sh """
                        docker compose build
                        docker login -u ${DOCKER_CREDENTIALS_USR} -p ${DOCKER_CREDENTIALS_PSW}
                        docker compose push
                    """    
                }
            }
        }

        stage ('deploy to kubernates using helm') {
            steps {
                script {
                    withCredentials([file(credentialsId: 'kubeconfig-credentials', variable: 'KUBECONFIG')])
                        sh """
                            helm upgrade --install ${HELM_RELEASE_NAME} ${HELM_CHART_PATH} --namespace default --create-namespace --kubeconfig=$KUBECONFIG --debug
                        """    
                }
            }
        }

        stage('verify deployment') {
            steps {
                script{
                    withCredentials([file(credentialsId: 'kubeconfig-credentials', variable: 'KUBECONFIG')])
                        sh "kubectl get pods -n ${BACKEND_NAMESPACE} --kubeconfig=$KUBECONFIG"
                        sh "kubectl get pods -n ${FRONTEND_NAMESPACE} --kubeconfig=$KUBECONFIG"
                        sh "kubectl get pods -n ${DATABASE_NAMESPACE} --kubeconfig=$KUBECONFIG"
                }
            }
        }
    }
    post {
        success {
            echo "Pipeline executed successfully!"
        }
        failure {
            echo "Pipeline failed"
        }
    }
}